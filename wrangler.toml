# Avatar Imaging CRM - Cloudflare Workers Configuration
# Platform: Cloudflare Workers + D1 + Queues + Workers AI
# Version: 1.0.0

name = "avatarimaging_cms"
main = "src/index.ts"
compatibility_date = "2025-01-02"
compatibility_flags = ["nodejs_compat"]

# =====================================================================
# WORKER CONFIGURATION
# =====================================================================

# Worker limits (Free tier: 100K requests/day, 10ms CPU time)
workers_dev = true
routes = []

# =====================================================================
# D1 DATABASE (SQLite at the edge)
# =====================================================================

[[d1_databases]]
binding = "DB"                            # Access in code: env.DB
database_name = "avatarimaging-crm-db"
database_id = "4b4ac289-5da1-4712-bdd8-b1dcff041bab"
migrations_dir = "migrations"

# =====================================================================
# QUEUES (Async job processing)
# =====================================================================

# Unified Queue: All async processing (automation, SMS, email)
[[queues.producers]]
queue = "avatar-queue"
binding = "QUEUE"              # Access in code: env.QUEUE

[[queues.consumers]]
queue = "avatar-queue"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3

# =====================================================================
# WORKERS AI (Edge inference)
# =====================================================================

[ai]
binding = "AI"                            # Access in code: env.AI

# =====================================================================
# KV NAMESPACES (Optional caching)
# =====================================================================

# Cache for warmness scores and AI results (optional optimization)
# Uncomment after creating KV namespace
# [[kv_namespaces]]
# binding = "CACHE"
# id = "YOUR_KV_ID_HERE"
# preview_id = "YOUR_PREVIEW_KV_ID_HERE"

# =====================================================================
# SECRETS (Set via: wrangler secret put SECRET_NAME)
# =====================================================================

# Required secrets (not committed to git):
# - GOOGLE_CLIENT_ID              # Google OAuth
# - GOOGLE_CLIENT_SECRET          # Google OAuth
# - SESSION_SECRET                # JWT signing key
# - WIX_WEBHOOK_SECRET            # Wix webhook verification
# - MANYCHAT_API_KEY              # ManyChat API key
# - MANYCHAT_WEBHOOK_SECRET       # ManyChat webhook verification
# - MOBILEMESSAGE_API_KEY         # MobileMessage.com.au SMS API key
# - MOBILEMESSAGE_WEBHOOK_SECRET  # MobileMessage webhook verification
# - CLICKSEND_API_KEY             # ClickSend SMS provider (legacy)
# - CLICKSEND_USERNAME            # ClickSend username (legacy)
# - SENDGRID_API_KEY              # SendGrid email/SMS (optional)

# =====================================================================
# ENVIRONMENT VARIABLES
# =====================================================================

[vars]
# Application
APP_NAME = "Avatar Imaging CRM"
APP_VERSION = "1.0.0"
ENVIRONMENT = "development"

# Frontend URL (CORS)
FRONTEND_URL = "http://localhost:5173"    # Update after Cloudflare Pages deployment

# SMS Provider
SMS_PROVIDER = "mobilemessage"            # mobilemessage | clicksend | sendgrid
SMS_FROM_NUMBER = "+61400000000"          # TODO: Update with your MobileMessage number
MOBILEMESSAGE_FROM_NUMBER = "+61400000000" # TODO: Update with actual number

# Wix Integration
WIX_SITE_ID = ""                          # TODO: Update with Wix site ID
WIX_BOOKING_CALENDAR_ID = ""              # TODO: Update with calendar ID

# ManyChat Integration (Instagram/Facebook)
MANYCHAT_PAGE_ID = ""                     # TODO: Update with Facebook Page ID
MANYCHAT_ENABLED = "false"                # Set to true when configured

# Google OAuth
GOOGLE_OAUTH_REDIRECT_URI = "https://avatarimaging-crm.workers.dev/auth/google/callback"

# AI Configuration
AI_MODEL_WARMNESS = "@cf/meta/llama-3.1-8b-instruct"
AI_MODEL_INTENT = "@cf/meta/llama-3.2-1b-instruct"
AI_MAX_TOKENS = 256

# Business Rules
WARMNESS_RECALC_INTERVAL_HOURS = 24       # Recalculate warmness every 24 hours
SPEED_TO_LEAD_TARGET_MINUTES = 5          # Target: respond within 5 minutes

# =====================================================================
# CRON TRIGGERS (Scheduled tasks)
# =====================================================================
# Note: Cron triggers temporarily disabled for initial deployment
# Re-enable after worker is deployed successfully

# [[triggers.crons]]
# cron = "0 */3 * * *"                      # Every 3 hours - Booking reminders
# name = "booking-reminders"

# [[triggers.crons]]
# cron = "0 2 * * *"                        # Daily at 2am - Warmness recalculation
# name = "warmness-recalculation"

# [[triggers.crons]]
# cron = "0 8 * * 1"                        # Weekly Monday 8am - Scheduled reports
# name = "scheduled-reports"

# =====================================================================
# OBSERVABILITY
# =====================================================================

[observability]
enabled = true
head_sampling_rate = 1.0                  # Sample 100% during development

# =====================================================================
# DEVELOPMENT CONFIGURATION
# =====================================================================

[env.development]
name = "avatarimaging-crm-dev"
vars = { ENVIRONMENT = "development" }

[env.development.d1_databases]
binding = "DB"
database_name = "avatarimaging-crm-db-dev"
database_id = ""                          # Local D1 for development

# =====================================================================
# PRODUCTION CONFIGURATION
# =====================================================================
# Note: For now, using same DB/Queue/AI as default until production DB is created
# When ready to separate production, create new D1 database and update database_id

[env.production]
name = "avatarimaging_cms"
workers_dev = false
# Routes commented out - add custom domain via Workers dashboard instead
# Uncomment when DNS is configured:
# routes = [
#   { pattern = "api.avatarimaging.com.au/*", zone_name = "avatarimaging.com.au" }
# ]

[env.production.vars]
ENVIRONMENT = "production"
FRONTEND_URL = "https://crm.avatarimaging.com.au"
APP_NAME = "Avatar Imaging CRM"
APP_VERSION = "1.0.0"
SMS_PROVIDER = "clicksend"
SMS_FROM_NUMBER = "+61400000000"
WIX_SITE_ID = ""
WIX_BOOKING_CALENDAR_ID = ""
MANYCHAT_PAGE_ID = ""
GOOGLE_OAUTH_REDIRECT_URI = "https://avatarimaging-crm.workers.dev/auth/google/callback"
AI_MODEL_WARMNESS = "@cf/meta/llama-3.1-8b-instruct"
AI_MODEL_INTENT = "@cf/meta/llama-3.2-1b-instruct"
AI_MAX_TOKENS = 256
WARMNESS_RECALC_INTERVAL_HOURS = 24
SPEED_TO_LEAD_TARGET_MINUTES = 5

# Use same D1 database for now (create separate production DB later if needed)
[[env.production.d1_databases]]
binding = "DB"
database_name = "avatarimaging-crm-db"
database_id = "4b4ac289-5da1-4712-bdd8-b1dcff041bab"

# Queues configuration (inherits from top level)
[[env.production.queues.producers]]
queue = "avatar-queue"
binding = "QUEUE"

[[env.production.queues.consumers]]
queue = "avatar-queue"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3

# AI binding (inherits from top level)
[env.production.ai]
binding = "AI"

# =====================================================================
# BUILD CONFIGURATION
# =====================================================================

# Build configuration handled by wrangler automatically
